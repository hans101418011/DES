<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>DES加密 with Javascript</title>
    <link rel="stylesheet" href="reset.css" type="text/css" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <script src="jquery-2.1.4.min.js"></script>
    
</head>
<body>
<header>
    <h1>DES加密 with Javascript</h1>
    <h2>By 101418011 HansChen</h2>
</header>
<div  id="input">
    <form>
        <label>Key:<input id="key" type="text" maxlength="7" value="science" required></label>
        <label>Plaintext:<input id="plaintext" type="text" value="security" required></label>
        <input type="submit" value="Create">
        <input type="reset" value="Reset">
    </form>
</div>
<section id="output">
    <table id="createKey">
        <thead>
            <tr><td>Key</td><td></td></tr>
        </thead>
        <tbody>
            <tr id="originalKey">
                <td>原始金鑰</td><td></td>
            </tr>
            <tr id="odd">
                <td>奇同位元</td><td></td>
            </tr>
            <tr id="KP">
                <td>KP</td><td></td>
            </tr>
            <tr id="KL1">
                <td>KL1</td><td></td>
            </tr>
            <tr id="KR1">
                <td>KR1</td><td></td>
            </tr>
            <tr id="keyR1">
                <td>回合金鑰1</td><td></td>
            </tr>
            <tr id="keyR2">
                <td>回合金鑰2</td><td></td>
            </tr>
            <tr id="keyR3">
                <td>回合金鑰3</td><td></td>
            </tr>
            <tr id="keyR4">
                <td>回合金鑰4</td><td></td>
            </tr>
            <tr id="keyR5">
                <td>回合金鑰5</td><td></td>
            </tr>
            <tr id="keyR6">
                <td>回合金鑰6</td><td></td>
            </tr>
            <tr id="keyR7">
                <td>回合金鑰7</td><td></td>
            </tr>
            <tr id="keyR8">
                <td>回合金鑰8</td><td></td>
            </tr>
            <tr id="keyR9">
                <td>回合金鑰9</td><td></td>
            </tr>
            <tr id="keyR10">
                <td>回合金鑰10</td><td></td>
            </tr>
            <tr id="keyR11">
                <td>回合金鑰11</td><td></td>
            </tr>
            <tr id="keyR12">
                <td>回合金鑰12</td><td></td>
            </tr>
            <tr id="keyR13">
                <td>回合金鑰13</td><td></td>
            </tr>
            <tr id="keyR14">
                <td>回合金鑰14</td><td></td>
            </tr>
            <tr id="keyR15">
                <td>回合金鑰15</td><td></td>
            </tr>
            <tr id="keyR16">
                <td>回合金鑰16</td><td></td>
            </tr>
        </tbody>
    </table>
    <table id="encrypt">
        <thead><tr><td>Plaintext</td><td></td></tr></thead>
        <tbody>
            <tr id="ptext">
                <td>明文</td><td></td>
            </tr>
            <tr id="IP">
                <td>IP</td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
            <tr id="FP">
                <td>FP</td><td></td>
            </tr>
        </tbody>
    </table>
</section>
<script type="text/javascript">
    var kpTable = [56,48,40,32,24,16, 8, 0,57,49,41,33,25,17,
                    9, 1,58,50,42,34,26,18,10, 2,59,51,43,35,
                   62,54,46,38,30,22,14, 6,61,53,45,37,29,21,
                   13, 5,60,52,44,36,28,20,12, 4,27,19,11, 3];
    var cpTable = [13,16,10,23, 0, 4, 2,27,14, 5,20, 9,
                   22,18,11, 3,25, 7,15, 6,26,19,12, 1,
                   40,51,30,36,46,54,29,39,50,44,32,47,
                   43,48,38,55,33,52,45,41,49,35,28,31];
    var shiftLTable = [1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28];
    
    var ipTable = [57,49,41,33,25,17, 9, 1,59,51,43,35,27,19,11, 3,
                   61,53,45,37,29,21,13, 5,63,55,47,39,31,23,15, 7,
                   56,48,40,32,24,16, 8, 0,58,50,42,34,26,18,10, 2,
                   60,52,44,36,28,20,12, 4,62,54,46,38,30,22,14, 6];
    
    
    $("form").submit(function(event){
        var patt = /^[a-zA-Z0-9]{7}$/;
        var okey=$("input#key").val();
        

        if(patt.test(okey)){
            $("#createKey thead td:last").html(okey);
            var keyHex = [];
            var c = [];
            var keyBit = "";
            for(i=0;i<7;i++){
                for(j=0;j<2;j++){
                    keyHex.push(char2ascii(okey[i]).substr(j,1));
                }
            }
            for(i=0;i< keyHex.length ; i++){
                keyBit += padLeft(hex2bit(keyHex[i]),4);
                c.push(padLeft(hex2bit(keyHex[i]),4));
            }
            for(i=0;i<c.length;i++){
                $("#originalKey td:last").append("<div>"+byte2hex(c[i]) + "<br>" +c[i]+"</div>");
            }
            
            /*
            *   odd
            */
            var oddParity = 0;
            var keyBit64 = "";
            for(i=0;i<keyBit.length;i++){
                keyBit64 += keyBit[i];
                oddParity += parseInt(keyBit[i]);
                if((i+1)%7 == 0){
                    if( oddParity%2 == 0){
                        keyBit64 += "1";
                    }else{
                        keyBit64 += "0";
                    }
                    oddParity = 0;
                }
            }
            for(i=0;i<64;i+=4){
                var temp = keyBit64.toString().substr(i,4);
                $("#odd td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>");
            }
            
            /*
            *   KP
            */
            var keyKp = "";
            for(i=0;i<56;i++){
                keyKp += keyBit64[kpTable[i]];
            }
            for(i=0;i<56;i+=4){
                var temp = keyKp.toString().substr(i,4);
                $("#KP td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            
            /*
            *   Key Round 1
            */
            var keyLeft0 = "";
            var keyRight0 = "";
            for(i=0;i<28;i++){
                keyLeft0 += keyKp[i];
                keyRight0 += keyKp[28+i]; 
            }
            var keyLeft1 = shiftLeft(keyLeft0,1);
            var keyRight1 = shiftLeft(keyRight0,1);
            var keyLR = "";
            for(i=0;i<28;i++){
                keyLR += keyLeft1[i];
            }
            for(i=0;i<28;i++){
                keyLR += keyRight1[i];
            }
            var keyRound1=cp(keyLR);
            var kR1Byte = bit2byteArray(keyRound1);
            var kR1Hex = byteArr2hexArr(kR1Byte);
            
            for(i=0;i<keyLeft1.length;i+=4){
                var temp = keyLeft1.toString().substr(i,4);
                $("#KL1 td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            for(i=0;i<keyRight1.length;i+=4){
                var temp = keyRight1.toString().substr(i,4);
                $("#KR1 td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            for(i=0;i<kR1Byte.length;i+=1){
                //$("#keyR1 td:last").append("<div>"+kR1Hex[i] + "<br>" +kR1Byte[i]+"</div>")
            }
            
            
            //  Key Round
            var keyRound = [];
            for(var round=1;round<=16;round++){
                keyRound.push(getRoundKey(round,keyKp));
                var kRByte = bit2byteArray(keyRound[keyRound.length-1]);
                for(j=0;j<kRByte.length;j+=1){
                    $("#keyR"+round+" td:last").append("<div>"+byte2hex(kRByte[j]) + "<br>" +kRByte[j]+"</div>")
                }
            }
            
            
            /*
            var htmlTable = ''<table><thead><tr><td>明文：</td><td></td></tr></thead><tbody>
            <tr>
                <td></td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
        </tbody>
    </table>';
    */
            //$("section#output").append('')
            var plaintext=$("input#plaintext").val();
            
            $("#encrypt thead td:last").html(plaintext);
            var textHex = [];
            var textByte = [];
            var textBit = "";
            for(i=0;i<plaintext.length;i++){
                for(j=0;j<2;j++){
                    textHex.push(char2ascii(plaintext[i]).substr(j,1));
                }
            }
            for(i=0;i< textHex.length ; i++){
                textBit += padLeft(hex2bit(textHex[i]),4);
                textByte.push(padLeft(hex2bit(textHex[i]),4));
            }
            for(i=0;i<textByte.length;i++){
                $("#ptext td:last").append("<div>"+byte2hex(textByte[i])+"<br>"+textByte[i]+"</div>");
            }
            
            /*
            *   IP
            */
            var textIP = "";
            for(i=0;i<textBit.length;i++){
                textIP += textBit[ipTable[i]];
            }
            for(i=0;i<textIP.length;i+=4){
                var temp = textIP.toString().substr(i,4);
                $("#IP td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            
            
            
            
            
            
            
            
           
        }else{
            alert("Input text error !!!");
            return true;
        }
        return false;
    })
    
    
    function char2ascii(char1){
        return char1.charCodeAt(0).toString(16);
    }
    function hex2bit(hex1){
        return parseInt(hex1,16).toString(2);
    }
    function byte2hex(byte1){
        return parseInt(byte1,2).toString(16);
    }
    function bit2byteArray(bit1){
        var arrByte = [];
        for(i=0;i < bit1.length;i+=4){
            arrByte.push(bit1.toString().substr(i,4));
        }
        return arrByte;
    }
    function byteArr2hexArr(byte1){
        var arrHex = [];
        for(i=0;i < byte1.length;i+=1){
            arrHex.push(byte2hex(byte1[i]));
        }
        return arrHex;
    }
    
    function padLeft(str,len){
        str = ''+str;
        if(str.length < len){
            return padLeft("0" + str ,len);
        }else{
            return str;
        }
    }
    function shiftLeft(keyPart,time){
        if(time > 0 && time < 28){
            var tempX = keyPart[0];
            var temp = "";
            for(i=0;i<27;i++){
                temp += keyPart[i+1].toString();
            }
            temp += tempX;
            time -= 1;
            return shiftLeft(temp,time);
        }else{
            return keyPart;
        }
    }
    function cp(tkeyLR){
        var temp = "";
        for(i=0;i<48;i++){
            temp += tkeyLR[cpTable[i]];
        }
        return temp;
    }
    function getRoundKey(time,KP){
        var keyL = "";
        var keyR = "";
        for(i=0;i<28;i++){
            keyL += KP[i];
            keyR += KP[28+i]; 
        }
        //console.log();
        var keyLeft = shiftLeft(keyL,parseInt(shiftLTable[time-1]));
        var keyRight = shiftLeft(keyR,parseInt(shiftLTable[time-1]));
        var keyLR = "";
        for(i=0;i<28;i++){
            keyLR += keyLeft[i];
        }
        for(i=0;i<28;i++){
            keyLR += keyRight[i];
        }
        return cp(keyLR);
    }
</script>
    <!-- HansChen Design -->
</body>
</html>