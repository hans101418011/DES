<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>DES加密 with Javascript</title>
    <link rel="stylesheet" href="reset.css" type="text/css" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <script src="jquery-2.1.4.min.js"></script>
    
</head>
<body>
<header>
    <h1>DES加密 with Javascript</h1>
    <h2>By 101418011 HansChen</h2>
</header>
<div  id="input">
    <form>
        <label>Key:<input id="key" type="text" maxlength="7" value="science" required></label>
        <label>Plaintext:<input id="plaintext" type="text" value="security" required></label>
        <input type="submit" value="Create">
        <input type="reset" value="Reset">
    </form>
</div>
<section id="output">
    <table id="createKey">
        <thead>
            <tr><td>Key</td><td></td></tr>
        </thead>
        <tbody>
            <tr id="originalKey">
                <td>原始金鑰</td><td></td>
            </tr>
            <tr id="odd">
                <td>奇同位元</td><td></td>
            </tr>
            <tr id="KP">
                <td>KP</td><td></td>
            </tr>
            <tr id="KL1">
                <td>KL1</td><td></td>
            </tr>
            <tr id="KR1">
                <td>KR1</td><td></td>
            </tr>
            <tr id="keyR1">
                <td>回合金鑰1</td><td></td>
            </tr>
            <tr id="keyR2">
                <td>回合金鑰2</td><td></td>
            </tr>
            <tr id="keyR3">
                <td>回合金鑰3</td><td></td>
            </tr>
            <tr id="keyR4">
                <td>回合金鑰4</td><td></td>
            </tr>
            <tr id="keyR5">
                <td>回合金鑰5</td><td></td>
            </tr>
            <tr id="keyR6">
                <td>回合金鑰6</td><td></td>
            </tr>
            <tr id="keyR7">
                <td>回合金鑰7</td><td></td>
            </tr>
            <tr id="keyR8">
                <td>回合金鑰8</td><td></td>
            </tr>
            <tr id="keyR9">
                <td>回合金鑰9</td><td></td>
            </tr>
            <tr id="keyR10">
                <td>回合金鑰10</td><td></td>
            </tr>
            <tr id="keyR11">
                <td>回合金鑰11</td><td></td>
            </tr>
            <tr id="keyR12">
                <td>回合金鑰12</td><td></td>
            </tr>
            <tr id="keyR13">
                <td>回合金鑰13</td><td></td>
            </tr>
            <tr id="keyR14">
                <td>回合金鑰14</td><td></td>
            </tr>
            <tr id="keyR15">
                <td>回合金鑰15</td><td></td>
            </tr>
            <tr id="keyR16">
                <td>回合金鑰16</td><td></td>
            </tr>
        </tbody>
    </table>
    <table id="encrypt">
        <thead><tr><td>Plaintext</td><td></td></tr></thead>
        <tbody>
            <tr id="ptext">
                <td>明文</td><td></td>
            </tr>
            <tr id="IP">
                <td>IP</td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
            <tr id="FP">
                <td>FP</td><td></td>
            </tr>
        </tbody>
    </table>
</section>
<script type="text/javascript">
    var kpTable = [56,48,40,32,24,16, 8, 0,57,49,41,33,25,17,
                    9, 1,58,50,42,34,26,18,10, 2,59,51,43,35,
                   62,54,46,38,30,22,14, 6,61,53,45,37,29,21,
                   13, 5,60,52,44,36,28,20,12, 4,27,19,11, 3];
    var cpTable = [13,16,10,23, 0, 4, 2,27,14, 5,20, 9,
                   22,18,11, 3,25, 7,15, 6,26,19,12, 1,
                   40,51,30,36,46,54,29,39,50,44,32,47,
                   43,48,38,55,33,52,45,41,49,35,28,31];
    var shiftLTable = [1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28];
    
    var ipTable = [57,49,41,33,25,17, 9, 1,59,51,43,35,27,19,11, 3,
                   61,53,45,37,29,21,13, 5,63,55,47,39,31,23,15, 7,
                   56,48,40,32,24,16, 8, 0,58,50,42,34,26,18,10, 2,
                   60,52,44,36,28,20,12, 4,62,54,46,38,30,22,14, 6];
    var epTable = [31, 0, 1, 2, 3, 4, 3, 4, 5, 6, 7, 8,
                    7, 8, 9,10,11,12,11,12,13,14,15,16,
                   15,16,17,18,19,20,19,20,21,22,23,24,
                   23,24,25,26,27,28,27,28,29,30,31, 1];
    
    var sbox=[];
    sbox = [0,1,2,3,4,5,6,7]
    for(var i=0;i<sbox.length;i++){sbox[i] = [];}
    sbox[0][0] = [14, 4,13, 1, 2,15,11, 8, 3,10, 6,12, 5, 9, 0, 7];
    sbox[0][1] = [ 0,15, 7, 4,14, 2,13, 1,10, 6,12,11, 9, 5, 3, 8];
    sbox[0][2] = [ 4, 1,14, 8,13, 6, 2,11,15,12, 9, 7, 3,10, 5, 0];
    sbox[0][3] = [15,12, 8, 2, 4, 9, 1, 7, 5,11, 3,14,10, 0, 6,13];
    
    sbox[1][0] = [15, 1, 8,14, 6,11, 3, 4, 9, 7, 2,13,12, 0, 5,10];
    sbox[1][1] = [ 3,13, 4, 7,15, 2, 8,14,12, 0, 1,10, 6, 9,11, 5];
    sbox[1][2] = [ 0,14, 7,11,10, 4,13, 1, 5, 8,12, 6, 9, 3, 2,15];
    sbox[1][3] = [13, 8,10, 1, 3,15, 4, 2,11, 6, 7,12, 0, 5,14, 9];
    
    sbox[2][0] = [10, 0, 9,14, 6, 3,15, 5, 1,13,12, 7,11, 4, 2, 8];
    sbox[2][1] = [13, 7, 0, 9, 3, 4, 6,10, 2, 8, 5,14,12,11,15, 1];
    sbox[2][2] = [13, 6, 4, 9, 8,15, 3, 0,11, 1, 2,12, 5,10,14, 7];
    sbox[2][3] = [ 1,10,13, 0, 6, 9, 8, 7, 4,15,14, 3,11, 5, 2,12];
    
    sbox[3][0] = [ 7,13,14, 3, 0, 6, 9,10, 1, 2, 8, 5,11,12, 4,15];
    sbox[3][1] = [13, 8,11, 5, 6,15, 0, 3, 4, 7, 2,12, 1,10,14, 9];
    sbox[3][2] = [10, 6, 9, 0,12,11, 7,13,15, 1, 3,14, 5, 2, 8, 4];
    sbox[3][3] = [ 3,15, 0, 6,10, 1,13, 8, 9, 4, 5,11,12, 7, 2,14];
    
    sbox[4][0] = [ 2,12, 4, 1, 8,10,11, 6, 8, 5, 3,15,13, 0,14, 9];
    sbox[4][1] = [14,11, 2,12, 4, 7,13, 1, 5, 0,15,10, 3, 9, 8, 6];
    sbox[4][2] = [ 4, 2, 1,11,10,13, 7, 8,15, 9,12, 5, 6, 3, 0,14];
    sbox[4][3] = [11, 8,12, 7, 1,14, 2,13, 6,15, 0, 9,10, 4, 5, 3];
    
    sbox[5][0] = [12, 1,10,15, 9, 2, 6, 8, 0,13, 3, 4,14, 7, 5,11];
    sbox[5][1] = [10,15, 4, 2, 7,12, 9, 5, 6, 1,13,14, 0,11, 3, 8];
    sbox[5][2] = [ 9,14,15, 5, 2, 8,12, 3, 7, 0, 4,10, 1,13,11, 6];
    sbox[5][3] = [ 4, 3, 2,12, 9, 5,15,10,11,14, 1, 7, 6, 0, 8,13];
    
    sbox[6][0] = [ 4,11, 2,14,15, 0, 8,13, 3,12, 9, 7, 5,10, 6, 1];
    sbox[6][1] = [13, 0,11, 8, 4, 9, 1,10,14, 3, 5,12, 2,15, 8, 6];
    sbox[6][2] = [ 1, 4,11,13,12, 3, 7,14,10,15, 6, 8, 0, 5, 9, 2];
    sbox[6][3] = [ 6,11,13, 8, 1, 4,10, 7, 9, 5, 0,15,14, 2, 3,12];
    
    sbox[7][0] = [13, 2, 8, 4, 6,15,11, 1,10, 9, 3,14, 5, 0,12, 7];
    sbox[7][1] = [ 1,15,13, 8,10, 3, 7, 4,12, 5, 6,11, 0,14, 9, 2];
    sbox[7][2] = [ 7,11, 4, 1, 9,12,14, 2, 0, 6,10,13,15, 3, 5, 8];
    sbox[7][3] = [ 2, 1,14, 7, 4,10, 8,13,15,12, 9, 0, 3, 5, 6,11];
    
    //console.log(sbox);
    
    $("form").submit(function(event){
        var patt = /^[a-zA-Z0-9]{7}$/;
        var okey=$("input#key").val();
        

        if(patt.test(okey)){
            $("#createKey thead td:last").html(okey);
            var keyHex = [];
            var c = [];
            var keyBit = "";
            for(i=0;i<7;i++){
                for(j=0;j<2;j++){
                    keyHex.push(char2ascii(okey[i]).substr(j,1));
                }
            }
            for(i=0;i< keyHex.length ; i++){
                keyBit += padLeft(hex2bit(keyHex[i]),4);
                c.push(padLeft(hex2bit(keyHex[i]),4));
            }
            for(i=0;i<c.length;i++){
                $("#originalKey td:last").append("<div>"+byte2hex(c[i]) + "<br>" +c[i]+"</div>");
            }
            
            /*
            *   odd
            */
            var oddParity = 0;
            var keyBit64 = "";
            for(i=0;i<keyBit.length;i++){
                keyBit64 += keyBit[i];
                oddParity += parseInt(keyBit[i]);
                if((i+1)%7 == 0){
                    if( oddParity%2 == 0){
                        keyBit64 += "1";
                    }else{
                        keyBit64 += "0";
                    }
                    oddParity = 0;
                }
            }
            for(i=0;i<64;i+=4){
                var temp = keyBit64.toString().substr(i,4);
                $("#odd td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>");
            }
            
            /*
            *   KP
            */
            var keyKp = "";
            for(i=0;i<56;i++){
                keyKp += keyBit64[kpTable[i]];
            }
            for(i=0;i<56;i+=4){
                var temp = keyKp.toString().substr(i,4);
                $("#KP td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            
            /*
            *   Key Round 1
            */
            var keyLeft0 = "";
            var keyRight0 = "";
            for(i=0;i<28;i++){
                keyLeft0 += keyKp[i];
                keyRight0 += keyKp[28+i]; 
            }
            var keyLeft1 = shiftLeft(keyLeft0,1);
            var keyRight1 = shiftLeft(keyRight0,1);
            var keyLR = "";
            for(i=0;i<28;i++){
                keyLR += keyLeft1[i];
            }
            for(i=0;i<28;i++){
                keyLR += keyRight1[i];
            }
            var keyRound1=cp(keyLR);
            var kR1Byte = bit2byteArray(keyRound1);
            var kR1Hex = byteArr2hexArr(kR1Byte);
            
            for(i=0;i<keyLeft1.length;i+=4){
                var temp = keyLeft1.toString().substr(i,4);
                $("#KL1 td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            for(i=0;i<keyRight1.length;i+=4){
                var temp = keyRight1.toString().substr(i,4);
                $("#KR1 td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            for(i=0;i<kR1Byte.length;i+=1){
                //$("#keyR1 td:last").append("<div>"+kR1Hex[i] + "<br>" +kR1Byte[i]+"</div>")
            }
            
            
            //  Key Round
            var keyRound = [];
            for(var round=1;round<=16;round++){
                keyRound.push(getRoundKey(round,keyKp));
                var kRByte = bit2byteArray(keyRound[keyRound.length-1]);
                for(j=0;j<kRByte.length;j+=1){
                    $("#keyR"+round+" td:last").append("<div>"+byte2hex(kRByte[j]) + "<br>" +kRByte[j]+"</div>")
                }
            }
            
            
            /*
            var htmlTable = ''<table><thead><tr><td>明文：</td><td></td></tr></thead><tbody>
            <tr>
                <td></td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
            <tr>
                <td></td><td></td>
            </tr>
        </tbody>
    </table>';
    */
            //$("section#output").append('')
            var plaintext=$("input#plaintext").val();
            
            $("#encrypt thead td:last").html(plaintext);
            var textHex = [];
            var textByte = [];
            var textBit = "";
            for(i=0;i<plaintext.length;i++){
                for(j=0;j<2;j++){
                    textHex.push(char2ascii(plaintext[i]).substr(j,1));
                }
            }
            for(i=0;i< textHex.length ; i++){
                textBit += padLeft(hex2bit(textHex[i]),4);
                textByte.push(padLeft(hex2bit(textHex[i]),4));
            }
            for(i=0;i<textByte.length;i++){
                $("#ptext td:last").append("<div>"+byte2hex(textByte[i])+"<br>"+textByte[i]+"</div>");
            }
            
            /*
            *   IP
            */
            var textIP = "";
            for(i=0;i<textBit.length;i++){
                textIP += textBit[ipTable[i]];
            }
            for(i=0;i<textIP.length;i+=4){
                var temp = textIP.toString().substr(i,4);
                $("#IP td:last").append("<div>"+byte2hex(temp) + "<br>" +temp+"</div>")
            }
            console.log("IP:"+textIP);
            /*
            *   
            */
            var textLeft = "";
            var textRight = "";
            for(var i=0;i<textIP.length/2;i++){
                textLeft += textIP[i];
                textRight += textIP[i+textIP.length/2];
            }
            //console.log("L:"+textLeft);
            //console.log("R:"+textRight);
            var textLeft_n = textRight;
            var textR_EP = ep(textRight);
            var textR_EP_K = "";
            for(var i=0;i<textR_EP.length;i++){
                textR_EP_K += textR_EP[i] ^ keyRound[0][i];
            }
            //console.log(keyRound[0]);
            //console.log(textR_EP);
            console.log(textR_EP_K);
            
            var text_sbox = "";
            for(var i=0;i<8;i++){
                var sboxIndex = str2index(textR_EP_K.toString().substr(i*6,6));
                console.log("sboxIndex: " + sboxIndex);
                console.log("sbox: " + sbox[i][sboxIndex[0]][sboxIndex[1]]);
                text_sbox += padLeft(parseInt(sbox[i][sboxIndex[0]][sboxIndex[1]],10).toString(2),4);
                console.log("sbox: " + padLeft(parseInt(sbox[i][sboxIndex[0]][sboxIndex[1]],10).toString(2),4));
            }
            console.log("text_sbox: " +text_sbox);
            
            
           
        }else{
            alert("Input text error !!!");
            return true;
        }
        return false;
    })
    
    
    function char2ascii(char1){
        return char1.charCodeAt(0).toString(16);
    }
    function hex2bit(hex1){
        return parseInt(hex1,16).toString(2);
    }
    function byte2hex(byte1){
        return parseInt(byte1,2).toString(16);
    }
    function bit2byteArray(bit1){
        var arrByte = [];
        for(i=0;i < bit1.length;i+=4){
            arrByte.push(bit1.toString().substr(i,4));
        }
        return arrByte;
    }
    function byteArr2hexArr(byte1){
        var arrHex = [];
        for(i=0;i < byte1.length;i+=1){
            arrHex.push(byte2hex(byte1[i]));
        }
        return arrHex;
    }
    
    function padLeft(str,len){
        str = ''+str;
        if(str.length < len){
            return padLeft("0" + str ,len);
        }else{
            return str;
        }
    }
    function shiftLeft(keyPart,time){
        if(time > 0 && time < 28){
            var tempX = keyPart[0];
            var temp = "";
            for(i=0;i<27;i++){
                temp += keyPart[i+1].toString();
            }
            temp += tempX;
            time -= 1;
            return shiftLeft(temp,time);
        }else{
            return keyPart;
        }
    }
    function cp(tkeyLR){
        var temp = "";
        for(i=0;i<48;i++){
            temp += tkeyLR[cpTable[i]];
        }
        return temp;
    }
    function getRoundKey(time,KP){
        var keyL = "";
        var keyR = "";
        for(i=0;i<28;i++){
            keyL += KP[i];
            keyR += KP[28+i]; 
        }
        //console.log();
        var keyLeft = shiftLeft(keyL,parseInt(shiftLTable[time-1]));
        var keyRight = shiftLeft(keyR,parseInt(shiftLTable[time-1]));
        var keyLR = "";
        for(i=0;i<28;i++){
            keyLR += keyLeft[i];
        }
        for(i=0;i<28;i++){
            keyLR += keyRight[i];
        }
        return cp(keyLR);
    }
    function ep(textRight){
        var temp = "";
        for(i=0;i<48;i++){
            temp += textRight[epTable[i]];
        }
        return temp;
    }
    function str2index(str){
        var temp = [];
        var s1 = str[0] + str[5];
        var s2 = str.toString().substr(1,4)
        temp.push(parseInt(s1,2).toString(10));
        temp.push(parseInt(s2,2).toString(10));
        return temp;
    }
</script>
    <!-- HansChen Design -->
</body>
</html>